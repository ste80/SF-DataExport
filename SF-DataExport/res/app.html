<script>
    //http://trendct.org/2016/01/22/how-to-choose-a-label-color-to-contrast-with-background/

    const { defer, interval, of, Subject, timer } = rxjs;
    const { bufferTime, concat, concatMap, delayWhen, filter, ignoreElements, retryWhen, switchMap, takeWhile, tap } = rxjs.operators;

    const dispatch$ = new Subject();
    dispatch$.pipe(
        bufferTime(100),
        filter(actions => !!actions.length),
        concatMap(actions => defer(async () => {
            const newState = await subscribeDispatch(actions);
            store.commit('setStates', [newState]);
        })),
        delayWhen(() =>
            interval(1000).pipe(
                takeWhile(_ => typeof subscribeDispatch === 'undefined'),
                ignoreElements(),
                concat(of(1)),
            )
        ),
        retryWhen(errors => errors.pipe(
            tap(err => {
                store.commit('setStates', [{ isLoading: true }]);
            }),
            delayWhen(val => timer(5000).pipe(tap(_ => {
                store.commit('setStates', [{ isLoading: false }]);
            }))),
        )),
    ).subscribe();

    const store = new Vuex.Store({
        state: Object.assign(appState, { dispatch$ }),
        mutations: {
            setStates(state, newStates) {
                const len = newStates ? newStates.length : 0;

                for (let i = 0; i < len; i++) {
                    const newState = newStates[i];

                    for (const stateName in newState) {
                        state[stateName] = newState[stateName];
                    }
                }
            },
        },
    });

    function storeCommit(newStates) {
        if (newStates && newStates.length) {
            store.commit('setStates', newStates);
        }
    }

    Vue.filter('orgname', (value) => {
        if (!value) return ''
        return value.replace(/^https:\/\/|\.my\.salesforce\.com$|\.salesforce\.com$/ig, '').toUpperCase();
    });
    Vue.filter('round', (value, dcp) => {
        return Math.round(value, dcp);
    });
    Vue.filter('empty', (value, emptyValue) => {
        return value || emptyValue || '';
    });
    Vue.mixin({
        methods: {
            dispatch(type, payload) { return this.$store.state.dispatch$.next({ type, payload }); },
            percent(a, b) {
                if (!b) return 0;
                return 100.0 * a / b;
            },
            orgHasOfflineAccess(org) { return this.$store.state.orgOfflineAccess.indexOf(org) >= 0; },
            orgIsSandbox(org) { return this.$store.state.orgSandboxes.indexOf(org) >= 0; },
        },
    });
</script>
<script src="/components/org-chart.js"></script>
<script src="/components/spinner.js"></script>
<script src="/components/button-iconleft.js"></script>
<script src="/components/v-modal.js"></script>
<script src="/components/overview-tab.js"></script>
<script src="/components/photos-tab.js"></script>
<script src="/components/limits-tab.js"></script>
<script src="/components/data-tab.js"></script>
<script src="/components/download-dataexport-tab.js"></script>
<script src="/components/setup-tab.js"></script>
<script src="/components/page-header.js"></script>
<script src="/components/organization-modal.js"></script>
<script src="/components/page-app.js"></script>

<div id="app"><page-app></page-app></div>
<script>
    const app = new Vue({ el: '#app', store });
    store.state.dispatch$.next({ type: 'isLoading', payload: false });
</script>